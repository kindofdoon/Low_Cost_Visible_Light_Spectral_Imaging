function compare_SPDs(SPD_est)

    % This is a one-off function used to compare estimated vs. measured
    % SPDs

%     clear
%     clc
    
    %%
    
    addpath('C:\Users\Admin\Desktop\PAINTERS_COPILOT') % for access to color data and functions
    
    %% Input data
    
    stations = 420 : 40 : 660;

    % X_Rite_ColorChecker_Classic_2014, measured by Spectro 1
    lambda_act = 400 : 10 : 700;
    R_act = [0.0632155562440557,0.176515425244967,0.265897512435913,0.0521293580532077,0.352189838886261,0.271171212196350,0.0462799544135730,0.288278569777806,0.122571120659510,0.157567873597145,0.0696500465273857,0.0658019458254180,0.168124248584111,0.0535029048720997,0.0360095861057443,0.0510186093548937,0.308193872372309,0.216131498416265,0.440504183371862,0.397463669379552,0.297899524370829,0.175106679399808,0.0939949800570803,0.0346018075942993;0.0637249400218327,0.191751986742020,0.322033156951269,0.0508271070818107,0.469105680783590,0.331382105747858,0.0381399964292843,0.371166070302328,0.115930656592051,0.167903512716293,0.0641602650284770,0.0523814211289090,0.212224538127581,0.0496027767658233,0.0244142810503640,0.0439027858277163,0.386858463287353,0.258579522371292,0.724594076474508,0.557821730772654,0.361039658387502,0.191512266794841,0.0975096498926483,0.0346121552089853;0.0642098337411880,0.191651011506716,0.332659284273783,0.0517925421396890,0.477355023225149,0.346713523070018,0.0407932549715040,0.400736530621847,0.118038187424342,0.165291662017504,0.0654491931200030,0.0524691479901473,0.228854631384214,0.0529129182298980,0.0262147039175033,0.0446023270487787,0.391485591729482,0.279353539148966,0.856926441192627,0.598101019859314,0.372148344914118,0.194971799850464,0.0975232645869253,0.0339748114347463;0.0650751764575640,0.188916683197021,0.335346023241679,0.0537521851559483,0.467680335044861,0.356648653745651,0.0483360526462397,0.420764277378718,0.121691380937894,0.155449171861013,0.0672931397954627,0.0569499656558040,0.254372467597326,0.0571255199611190,0.0364383098979793,0.0503751399616400,0.375606775283813,0.300522734721502,0.877062439918518,0.599696179231008,0.373166541258494,0.195949286222458,0.0975119272867837,0.0331486326952777;0.0660419960816703,0.191310783227285,0.338617364565531,0.0581597921748957,0.451051513353984,0.370207111040751,0.0531376178065937,0.428870369990667,0.124866053462028,0.144926299651464,0.0774629339575767,0.0621061312655607,0.286181797583898,0.0680478885769843,0.0443744771182537,0.0598980051775773,0.350325326124827,0.330620259046554,0.884477992852529,0.600327134132385,0.374877621730169,0.198346743981043,0.0981032152970633,0.0340865502754847;0.0674644907315573,0.201734662055969,0.336825609207153,0.0635808507601420,0.427344779173533,0.392631600300471,0.0602025538682937,0.421591659386953,0.130018949508667,0.131875966986020,0.0878434479236600,0.0714191620548567,0.299968053897222,0.0798865308364233,0.0516785035530727,0.0690548618634543,0.324508170286814,0.359087387720744,0.886627455552419,0.600119372208913,0.375093321005503,0.199619109431902,0.0981591145197553,0.0346643750866257;0.0691279346744220,0.218361929059029,0.330729236205419,0.0681067556142810,0.409009923537572,0.425201207399368,0.0651058529814083,0.393969148397446,0.129234125216802,0.120878080526988,0.0995788176854453,0.0775096590320270,0.286913196245829,0.0901786635319393,0.0576643223563830,0.0747976476947467,0.290262411038081,0.388844589392344,0.889762719472249,0.599352538585663,0.374236007531484,0.198862140377363,0.0976435095071790,0.0352916469176610;0.0703182046612107,0.236126989126205,0.323984046777089,0.0723812753955523,0.395620316267014,0.469260523716609,0.0702564294139547,0.360336840152740,0.126775642236074,0.112294569611549,0.110712925593058,0.0825828860203427,0.262848893801371,0.101047510902087,0.0591710557540257,0.0797417958577477,0.268558492263158,0.420845429102580,0.893936117490133,0.601156572500864,0.374073853095372,0.197977344195048,0.0962428202231727,0.0362349624435107;0.0727295801043510,0.265375375747681,0.309525330861409,0.0803824091951053,0.372668991486232,0.520802795886993,0.0753645276029907,0.302694211403529,0.118913476665815,0.100963128109773,0.137404049436252,0.0831061626474063,0.214621141552925,0.122044670085112,0.0603425179918607,0.0951074610153837,0.233222857117653,0.443220833937327,0.897242426872253,0.598791420459747,0.370985517899195,0.195462723573049,0.0961160287261010,0.0353271129230660;0.0749541396896043,0.293679088354111,0.292217741409938,0.0897703394293787,0.352642049392064,0.552844206492106,0.0856662566463153,0.256280700365702,0.116743616759777,0.0862823749581977,0.171641652782758,0.0875857149561243,0.170971150199572,0.150042191147804,0.0582424799601237,0.128224139412244,0.202247947454453,0.447172174851100,0.899217545986176,0.598284880320231,0.368981719017029,0.194128533204397,0.0955604314804080,0.0351457049449287;0.0781955321629844,0.316416352987289,0.273352901140849,0.104666754603386,0.326904565095902,0.574678480625153,0.0978152006864550,0.213085452715556,0.112746966381868,0.0752987538774807,0.240276147921880,0.108709854384263,0.134515374898911,0.205616136391958,0.0585860212643943,0.211313913265864,0.182634522517522,0.432542721430460,0.897681891918182,0.598893324534098,0.368547668059667,0.194539725780487,0.0958044677972797,0.0342297417422133;0.0802010198434197,0.316527833541234,0.251675268014272,0.123103673259417,0.294491340716680,0.579759657382965,0.103992621103923,0.172755494713783,0.106559018294017,0.0671659161647163,0.336386154095332,0.147004033128421,0.106173624595006,0.285875370105108,0.0591206712027390,0.330652435620626,0.160466119647026,0.392501960198085,0.895089109738668,0.597634375095367,0.370117902755737,0.195973436037699,0.0968271593252820,0.0335872384409113;0.0806662440299987,0.301705141862233,0.224223613739014,0.140754749377569,0.270052105188370,0.571603039900462,0.119936595360438,0.135837137699127,0.0996288458506267,0.0550349069138367,0.457242995500565,0.214582443237304,0.0792361522714297,0.348268290360769,0.0580818131566047,0.465490678946177,0.133859669168790,0.336310128370921,0.896210889021556,0.599883397420247,0.371530671914419,0.196562061707179,0.0963932101925213,0.0334885629514853;0.0818372194965680,0.279066612323125,0.201184084018071,0.157129526138306,0.252598772446315,0.550628781318665,0.146842102209727,0.105654972294967,0.0976671874523163,0.0501402020454410,0.557349403699239,0.304613282283147,0.0543026539186637,0.371518443028132,0.0534481704235080,0.574223756790161,0.109692834317684,0.275583475828171,0.898034214973450,0.599563757578532,0.371394038200378,0.196942051251729,0.0966674238443376,0.0341598937908810;0.0841106474399567,0.265596340099970,0.189374109109243,0.164501766363780,0.238473897178968,0.519807815551758,0.173610076308250,0.0974022994438810,0.0976181874672573,0.0504490161935490,0.593063473701477,0.384020696083705,0.0448954800764720,0.355227659145991,0.0503458715975287,0.628348668416341,0.106403003136317,0.224939818183581,0.898613949616750,0.597000598907471,0.370497186978658,0.196826080481212,0.0955989832679430,0.0346616531411807;0.0873316526412967,0.255733698606491,0.179189950227737,0.163500865300496,0.220329056183497,0.482270151376724,0.203216393788656,0.0888448730111120,0.0926741510629653,0.0485421034197013,0.585170348485311,0.436827113231023,0.0406012249489627,0.319221744934718,0.0483704792956510,0.652930100758870,0.108936188121637,0.177005817492803,0.897676765918732,0.594357470671336,0.370410074790319,0.196636259555817,0.0947932998339333,0.0339920657376447;0.0965097248554234,0.259520053863526,0.166410669684410,0.160520205895106,0.199756552775701,0.441143224636714,0.265106687943141,0.0794916798671087,0.0989521245161694,0.0464108238617583,0.557538966337840,0.466557731231054,0.0393577714761100,0.276647945245107,0.0558988824486733,0.670078436533610,0.110098640124003,0.140467340747515,0.902063190937042,0.594317416350047,0.373426705598831,0.199066186944644,0.0956156502167383,0.0349687710404397;0.109699544807275,0.285234173138936,0.156890168786049,0.151930024226506,0.175462265809377,0.396624942620595,0.342057079076767,0.0774529402454693,0.111885274449984,0.0410147743920487,0.516760249932607,0.496225863695145,0.0403007455170157,0.231503710150719,0.0617509086926780,0.682609399159749,0.108319076399008,0.114848735431830,0.903516372044881,0.594215810298919,0.373867164055507,0.199768786629041,0.0960142711798350,0.0350088067352773;0.123068007330100,0.322385638952255,0.153183971842130,0.139006232221921,0.168092002471288,0.356045285860697,0.422460198402405,0.0757468019922574,0.161866063872973,0.0449264521400133,0.472674806912740,0.541678826014201,0.0392741709947590,0.191279316941897,0.0758904318014783,0.693845272064209,0.134516919652621,0.101051673293114,0.900200009346008,0.594801187515259,0.372773379087448,0.198378811279933,0.0953833982348443,0.0349781227608523;0.136794110139211,0.399390518665314,0.152522181471189,0.128000741203626,0.189874624212583,0.312935292720795,0.522051632404328,0.0861849089463553,0.272599081198374,0.0519167557358743,0.426182359457016,0.592005133628845,0.0453010325630503,0.158290599783261,0.131143897771835,0.706986248493195,0.217336356639862,0.0934229219953220,0.902229547500610,0.595949272314707,0.373309959967931,0.198622653881709,0.0961328695217767,0.0350725154081983;0.147857680916786,0.478930135567983,0.150140076875687,0.118683385352294,0.218343605597814,0.272003283103307,0.577282706896464,0.0886880233883860,0.402493149042129,0.0631015971302987,0.383892705043157,0.621757785479228,0.0495626553893090,0.130740240216255,0.220732862750689,0.716282327969869,0.337691714366277,0.0894729296366373,0.901150961716970,0.592000782489776,0.370334933201472,0.197536970178286,0.0962313065926237,0.0349993196626503;0.154140830039978,0.524484395980835,0.143039589126905,0.112771389385064,0.254913737376531,0.232646415630976,0.595920840899149,0.0796817640463510,0.503517071406047,0.0851810599366823,0.351506183544795,0.639972786108653,0.0449639397362867,0.113044058283170,0.338646441698074,0.723298033078512,0.446590433518092,0.0795057415962220,0.899542450904846,0.585613727569580,0.364649405082067,0.195022404193878,0.0941574846704800,0.0350852223734060;0.157881210247676,0.547364850838979,0.137413998444875,0.109419599175453,0.284891575574875,0.208722541729609,0.606909632682800,0.0727124710877737,0.572547634442647,0.105161214868228,0.331444819768270,0.649426380793254,0.0404652456442517,0.103345617651940,0.462180246909460,0.725004275639852,0.523675143718720,0.0754716619849207,0.899742921193441,0.581488112608592,0.360005170106888,0.192783688505491,0.0926173627376557,0.0353834107518200;0.160492097338040,0.558219512303670,0.136064598957698,0.108363779882590,0.312730759382248,0.194431260228157,0.614779273668925,0.0677940150101983,0.600904345512390,0.122859895229340,0.323020835717519,0.659153978029887,0.0399299574395020,0.0996631930271787,0.530989209810893,0.733487566312154,0.579729616641999,0.0720151861508687,0.902158657709757,0.579268236955007,0.356330692768097,0.190884480873744,0.0913766026496887,0.0358073016007740;0.161808639764786,0.559496521949768,0.138726527492205,0.107226148247719,0.348056097825368,0.181184917688370,0.620223740736643,0.0741478130221367,0.609422882397969,0.144748657941818,0.313434600830078,0.666962047417958,0.0441784088810287,0.0958520844578740,0.564825991789500,0.735606571038564,0.632397870222728,0.0697007750471433,0.902329504489899,0.576249996821086,0.351856797933578,0.188250591357549,0.0904315610726677,0.0353616649905843;0.164425854881604,0.566567460695903,0.146534025669098,0.107758030295372,0.379006912310918,0.172575389345487,0.627083619435628,0.0966687103112540,0.609860638777415,0.179002354542414,0.308463543653488,0.675111750761668,0.0604825665553413,0.0933218151330947,0.590325891971588,0.736772199471792,0.696894407272339,0.0729050710797310,0.903308192888896,0.576991260051728,0.350210289160410,0.187486375371615,0.0906330645084383,0.0352853797376157;0.164817497134209,0.573444982369741,0.156779805819194,0.107360919316610,0.408420314391454,0.168861761689186,0.631028592586518,0.123802850643794,0.606753289699554,0.221798479557037,0.311039745807648,0.681671102841695,0.0771549443403880,0.0933821176489197,0.611686766147613,0.739392320315043,0.748858928680420,0.0737904161214830,0.905086716016134,0.579668323198954,0.350041309992472,0.186054189999898,0.0895055457949640,0.0343161610265573;0.164847443501155,0.583305795987447,0.160756339629491,0.106072656810284,0.417805214722951,0.171935478846232,0.631491680939992,0.149991412957509,0.600847979386648,0.265671610832214,0.320017417271932,0.683722813924154,0.0820971007148427,0.0960521226127947,0.629879832267761,0.738837917645772,0.778900782267253,0.0770075768232347,0.904254078865051,0.577374259630839,0.346539308627446,0.182983259359996,0.0887677321831387,0.0338928687075777;0.164270987113317,0.600270072619120,0.160180911421776,0.108304545283318,0.402464707692464,0.180414125323296,0.632856766382853,0.170682991544406,0.601217846075694,0.299664199352265,0.338728179534276,0.690700232982635,0.0850293462475143,0.104448211689790,0.651251733303070,0.741258859634400,0.793738663196564,0.0796034211913747,0.903962353865306,0.575188457965851,0.344669193029404,0.180780768394470,0.0873524372776347,0.0343051676948867;0.162088329593341,0.615434765815735,0.158238992094994,0.109002659718196,0.396920233964920,0.190665562947591,0.630982855955760,0.176969130833944,0.601997017860413,0.320183952649434,0.356010347604752,0.694091578324636,0.0807791749636333,0.112942844629288,0.665387034416199,0.743153234322866,0.796571473280589,0.0790263985594117,0.906687359015147,0.570091883341471,0.340849161148071,0.177511433760325,0.0853423227866493,0.0347804725170137;0.160647978385289,0.638522247473399,0.154762893915176,0.110562366743883,0.406455417474111,0.199685608347257,0.631621003150940,0.185648143291474,0.614820877710978,0.345591525236765,0.377738336722056,0.701678673426310,0.0760087221860887,0.123133440812429,0.686997175216675,0.751107811927795,0.804737607638041,0.0774789700905480,0.907702366511027,0.563220719496409,0.336193581422170,0.175010050336520,0.0842118263244630,0.0351182023684187];
    
    lambda_est = 420 : 5 : 660;
%     SPD_est = [0.0681445072675246,0.204034814228794,0.274935630208411,0.0680894615047600,0.402543623798975,0.300508469945652,0.0503156410809402,0.341552787024536,0.130393630730025,0.164355792838258,0.0779541710896294,0.0631084902834098,0.209070831212909,0.0681347311250685,0.0518234392474278,0.0595802714657825,0.312481056897036,0.218312826787597,0.651870920792293,0.464789664736233,0.294107157273189,0.156644230240212,0.0772666351742274,0.0319191066469391;0.0725200636341986,0.213238971063069,0.306601561088973,0.0715114329315391,0.430098203645625,0.328760370914228,0.0534473156881815,0.375624357813016,0.137019287225972,0.167053183735737,0.0766438353326554,0.0650909215506346,0.234580297487801,0.0670366212758088,0.0550126343199647,0.0571730368798265,0.322290984857684,0.255831615467148,0.711744265100165,0.502659303859202,0.317148000428360,0.169514114524150,0.0831046783411854,0.0337316519719373;0.0765484907509365,0.222768079218127,0.334317687888959,0.0748961042651328,0.453682012746998,0.355920409674122,0.0566091567784971,0.404197872872070,0.142745083280851,0.168844325366657,0.0772482649090521,0.0673596191821241,0.256142077083126,0.0674565676723770,0.0579331864676662,0.0564689705899619,0.329753331281362,0.290124352640735,0.765584681823452,0.536509178555961,0.337692187120737,0.181027520844534,0.0883580646431936,0.0353548540318832;0.0802297886177383,0.232622138693969,0.358084010608368,0.0782434755055409,0.473295051103095,0.381988586225334,0.0598011643518870,0.427273332201700,0.147571018894660,0.169729217731018,0.0797674598188194,0.0699145831778784,0.273756169998881,0.0693945703147732,0.0605850956905321,0.0574680725961887,0.334868096168072,0.321191038308358,0.813392170962153,0.566339288826510,0.355739717350320,0.191184449201362,0.0930267940802520,0.0367887128267769;0.0835639572346040,0.242801149490593,0.377900529247201,0.0815535466527635,0.488937318713916,0.406964900567863,0.0630233384083512,0.444850735801905,0.151497094067401,0.169707860828820,0.0842014200619574,0.0727558135378975,0.287422576235069,0.0728506292029974,0.0629683619885626,0.0601703428985069,0.337635279517812,0.349031672470019,0.855166732516268,0.592149634670849,0.371290591117110,0.199984899594636,0.0971108666523608,0.0380332283566183;0.0865509966015335,0.253305111608001,0.393767243805458,0.0848263177068007,0.500608815579461,0.430849352701709,0.0662756789478897,0.456930083672684,0.154523308799072,0.168780254660063,0.0905501456384660,0.0758833102621814,0.297141295791687,0.0778247443370495,0.0650829853617576,0.0645757814969165,0.338054881330584,0.373646255125715,0.890908366485798,0.613940216088979,0.384344808421105,0.207428872024356,0.100610282359520,0.0390884006214075;0.0891909067185270,0.264134025046193,0.405684154283139,0.0880617886676523,0.508309541699730,0.453641942626873,0.0695581859705026,0.463511375814039,0.156649663089675,0.166946399224746,0.0988136365483453,0.0792970733507301,0.302912328668737,0.0843169157169297,0.0669289658101171,0.0706843883914176,0.336126901606386,0.395034786275448,0.920617072870743,0.631711033080899,0.394902369262308,0.213516366490520,0.103525041201729,0.0399542296211443;0.0914836875855844,0.275287889805167,0.413651260680244,0.0912599595353185,0.512039497074722,0.475342670343355,0.0728708594761898,0.464594612225968,0.157876156939209,0.164206294522870,0.108991892791595,0.0829971028035435,0.304735674866219,0.0923271433426379,0.0685063033336411,0.0784961635820101,0.331851340345220,0.413197265919218,0.944292851671102,0.645462085646609,0.402963273640716,0.218247382993129,0.105855143178988,0.0406307153558290;0.0934293392027056,0.286766705884924,0.417668562996772,0.0944208303097991,0.511798681704438,0.495951535851154,0.0762136994649513,0.460179792908473,0.158202790347674,0.160559940554435,0.121084914368216,0.0869833986206217,0.302611334384133,0.101855427214174,0.0698149979323296,0.0880111070686940,0.325228197547084,0.428133694057023,0.961935702886875,0.655193373786110,0.408527521556331,0.221621921532184,0.107600588291298,0.0411178578254613;0.0948548364515033,0.299983189419837,0.415862121033917,0.0971802350235406,0.505606783249035,0.516497620524631,0.0792131485091366,0.447029952204178,0.157149831845101,0.155433044516798,0.134911458866498,0.0898541274984225,0.294327368463367,0.113741753945199,0.0707950516094651,0.0981613216148555,0.314833676946968,0.439898977161946,0.970749169499240,0.658848171905395,0.410282641220860,0.222962655612205,0.108485661617929,0.0413152522429357;0.0956860257098114,0.315542790181777,0.407428817563618,0.0993821025475914,0.492615096420011,0.537421959238511,0.0817091105683241,0.423757819117067,0.154511682230074,0.148579480923111,0.150393850967140,0.0910085037354280,0.278935803350018,0.128346117798709,0.0714207509378829,0.108489136976232,0.300057580145583,0.448516646579592,0.969534769928702,0.655545026178463,0.407666144725035,0.221979302449415,0.108392199621426,0.0411798679852069;0.0960712142219620,0.332234608626999,0.393974887041997,0.101338575139855,0.474521031794372,0.557842482243344,0.0840217777233571,0.393137935639174,0.150699539905425,0.140491500747069,0.167687441308746,0.0916480987346741,0.258332586551894,0.144948530248711,0.0717435227719123,0.119909893641348,0.282120303941508,0.453939639618748,0.960689467334251,0.647046844257318,0.401803007887392,0.219252427611367,0.107556529376699,0.0407977662983655;0.0961587092322871,0.348847745211755,0.377106563925172,0.103361795058233,0.453021999949125,0.576877119789676,0.0864713420550788,0.357944843762535,0.146124603273984,0.131661354962366,0.186947580529926,0.0929744838991971,0.234413665576805,0.162829002769209,0.0718147939658827,0.133338932098732,0.262242245133324,0.456120893588204,0.946610224874878,0.635116533793966,0.393818206526468,0.215362596665616,0.106214977958659,0.0402550084285019;0.0960968179851190,0.364171300392298,0.358430082669265,0.105763904560631,0.429815411461279,0.593643802128058,0.0893779956443326,0.320953085479183,0.141198070738581,0.122581294542696,0.208329619269287,0.0961892306320330,0.209074987932560,0.181267546834209,0.0716859913741234,0.149691592836908,0.241643800519612,0.455013345796747,0.929694005709573,0.621517002440409,0.384836716460798,0.210890375179715,0.104603872442217,0.0396376556217069;0.0960338477247896,0.376994374624882,0.339551677730396,0.108857045904950,0.406598676907842,0.607260459509036,0.0930619305719617,0.284937202781155,0.136331140702048,0.113743570461753,0.231988908165435,0.102493910336218,0.184212501126966,0.199544173917716,0.0714085418509636,0.169883216344404,0.221545366898953,0.450569933553165,0.912337772997329,0.608011157848653,0.375983513508919,0.206416328721218,0.102959539902284,0.0390317691240710;0.0961181056956312,0.386106068365758,0.322077583564685,0.112953361349094,0.385069206865820,0.616845022183160,0.0978433389188094,0.252671737660484,0.131935011567214,0.105640433693231,0.258080797856978,0.113090094414788,0.161722152667834,0.216938895493735,0.0710338722507327,0.194829143109744,0.203167341069926,0.442743594166248,0.896938489897135,0.596361907670703,0.368383573489367,0.202521022857678,0.101518307413769,0.0385234101816847;0.0964978991419759,0.390295482071181,0.307614034628253,0.118364993150966,0.366924411912221,0.621515420400978,0.104042412765719,0.226931232109205,0.128420881736912,0.0987641352108245,0.286760638982524,0.129179354270779,0.143499890062973,0.232731723036271,0.0706134094277600,0.225444713621457,0.187730119831113,0.431487264944782,0.885893119567982,0.588332159558564,0.363161872220679,0.199785023156649,0.100516502051583,0.0381986400406386;0.0969229935851207,0.388065038459130,0.295299151834735,0.126180769575264,0.351475813111870,0.620858813935885,0.110927565846103,0.206607293627668,0.125318918063902,0.0928933316212922,0.322064704089119,0.152876216291971,0.128554775640381,0.248831422624215,0.0699299979549330,0.265756721854570,0.174349783836965,0.414773104944288,0.878162844076450,0.583568906848536,0.360055511214103,0.198028572338799,0.0999037847344914,0.0380650962689236;0.0971449006824481,0.379926156355165,0.283233811331767,0.136570052965998,0.336811766562066,0.615538337690245,0.117880316349669,0.188582475914083,0.122036145958578,0.0874643510192506,0.365574871279207,0.183942552355950,0.114656457533193,0.266741740220893,0.0688415932641277,0.316619183809312,0.161485227845504,0.391776861084953,0.871019633680605,0.580241901301890,0.357880414147280,0.196621711981984,0.0994335081658580,0.0380440890184491;0.0973145468824183,0.367681430376910,0.271468380426465,0.148465786700040,0.322794935388526,0.606285884608053,0.125390513041702,0.172617740257279,0.118799051660216,0.0824559516101803,0.413764899524486,0.220050952100459,0.101841761956919,0.285135157126972,0.0675122884981569,0.374188273012001,0.149371069810665,0.364256852472564,0.864326633826668,0.577898188208077,0.356379790088341,0.195469705939536,0.0990475370974951,0.0380921884111846;0.0975828586334914,0.353133455141986,0.260053226425946,0.160800914154262,0.309287982716970,0.593833347633306,0.133948004687486,0.158474047946087,0.115834121408092,0.0778468915995621,0.463108547796655,0.258874005163244,0.0901475151270713,0.302684154643113,0.0661061767998328,0.434620162988958,0.138241927686384,0.333971398212909,0.857946989960863,0.576084812856551,0.355296848105415,0.194477818064787,0.0986877362812146,0.0381659645690990;0.0981007623841275,0.338084825268018,0.249038716637329,0.172508378705537,0.296153571673115,0.578912619710002,0.144042640052306,0.145912360269335,0.113367841441483,0.0736159291928767,0.510079575067412,0.298084301182051,0.0796105432591601,0.318061214069982,0.0647873513119681,0.494071027266503,0.128332419426597,0.302678817411776,0.851743847529409,0.574348820536765,0.354374797266631,0.193551312211069,0.0982959704688284,0.0382219876141616;0.0990191845827869,0.324338135372627,0.238475218367730,0.182521123730736,0.283254365382682,0.562255593782137,0.156164267901447,0.134693638515852,0.111626697999666,0.0697418225956048,0.551151740308457,0.335354429794623,0.0702676725686964,0.329938816708243,0.0637199051773752,0.548697039370956,0.119877162985237,0.272137429174954,0.845580351978530,0.572237256538173,0.353356846640119,0.192595452231714,0.0978141044121485,0.0382168276683414;0.100489051677930,0.313695980073437,0.228413098924268,0.189772092606731,0.270453026971389,0.544594162793708,0.170802737000194,0.124578843974468,0.110837177321916,0.0662033300132271,0.582798802491488,0.368356980638706,0.0621557292711912,0.336989443858558,0.0630679315388666,0.594654372828638,0.113110776316242,0.244105552608230,0.839319648754446,0.569297166150227,0.351986205294009,0.191515501980056,0.0971840028629868,0.0381070548536077;0.102661290118016,0.307960953988070,0.218902725614059,0.193194228710396,0.257612219564954,0.526660219688711,0.188447896113831,0.115328937934013,0.111225765647512,0.0629792096512243,0.601494520588204,0.394764543352045,0.0553115395821554,0.337885576821594,0.0629955235392547,0.628099201165868,0.108267877373546,0.220341506817393,0.832824883303381,0.565075594662380,0.350006082296428,0.190216725309425,0.0963475305731551,0.0378492392919296;0.105844967891670,0.306191436630217,0.209879061267891,0.192289722871817,0.243638173980386,0.507175836783465,0.210415558225892,0.107421600998917,0.110950251002682,0.0597457162810039,0.606215771637805,0.414871416269944,0.0501736917121637,0.331226392032356,0.0615030022243854,0.648713635318796,0.103875370915420,0.199844471960249,0.826415610181242,0.559530896069159,0.347552903456067,0.188690661571313,0.0952140982908743,0.0373718000354695;0.110028803233576,0.306267119584199,0.201266263949323,0.187861472706868,0.228192929019527,0.484896289885918,0.236803120552860,0.101289209343623,0.109005412789836,0.0563843322279492,0.599882399160232,0.431020308547777,0.0468950794509757,0.317675840057598,0.0575770831445614,0.660022224234990,0.0990784847392790,0.180510935622728,0.820359119010827,0.553076607521119,0.344929699768906,0.187023909675088,0.0938002489541321,0.0366854213237550;0.114883197961290,0.308222565573587,0.193098493814630,0.180793481771101,0.212272859785349,0.460603277177514,0.266272808209440,0.0966247676119767,0.106873224312512,0.0531816570285051,0.584882611848304,0.443956426053391,0.0450839873828799,0.299003563395598,0.0528614511992811,0.663944798457899,0.0950393213577768,0.162445178052800,0.814440157838690,0.545942549041759,0.342129588084014,0.185264322810903,0.0922085455993915,0.0358700710598029;0.120078553892366,0.312092337321950,0.185409911020086,0.171969753620066,0.196874341380821,0.435078496839695,0.297486846310337,0.0931212804478257,0.106035658874253,0.0504242902191163,0.563604618394834,0.454424974654636,0.0443487000921648,0.276979204544639,0.0489997912880429,0.662401188530974,0.0929199832835659,0.145751479498434,0.808443474711387,0.538358540654575,0.339145685250460,0.183459754168910,0.0905415512631156,0.0350057171466301;0.125285272844356,0.317910997552858,0.178234675721966,0.162274291809313,0.182993748908915,0.409103647053906,0.329107459970258,0.0904717524950160,0.107974689778598,0.0483988313362276,0.538436627492638,0.463171160219360,0.0442975021631188,0.253372406002999,0.0476357883103452,0.657311224997662,0.0938825730292990,0.130534120207603,0.802153817675471,0.530554402383066,0.335971108117313,0.181658056939260,0.0889018289817670,0.0341723274872535;0.130173756634816,0.325713108989881,0.171606948076545,0.152591099894395,0.171627457472600,0.383460426001588,0.359796874303908,0.0883691883973943,0.114172290329088,0.0473918799162839,0.511766847834533,0.470940188615411,0.0445386781800304,0.229952810268959,0.0504131271656862,0.650594738401413,0.0990891931076292,0.116897380428275,0.795355934777496,0.522759954250729,0.332598973533641,0.179907084312106,0.0873919417918088,0.0334498699846899;0.134414407081299,0.335533234356587,0.165560888240097,0.143804181430860,0.163771842174847,0.358930531864186,0.388217314425993,0.0865065927988068,0.126110433829264,0.0476900354957299,0.485983488113335,0.478477265710638,0.0446805127271880,0.208490059840799,0.0589754927535645,0.644171559285677,0.109701946031209,0.104945540408423,0.787834574064017,0.515205016281063,0.329022398348513,0.178254689477599,0.0861144527297039,0.0329183125419562;0.137677626001360,0.347405936376548,0.160130656368898,0.136797539974261,0.160423278118626,0.336295662823142,0.413031005451218,0.0845769703431002,0.145271093582667,0.0495798976110104,0.463474757021858,0.486527597372889,0.0443312903888801,0.190753797216799,0.0749665699734782,0.639961518193902,0.126882934312692,0.0947828803960152,0.779374483581588,0.508119408497564,0.325234499410999,0.176748725625891,0.0851719248319152,0.0326576230620693;0.140033305165485,0.363357668578108,0.155347337463537,0.131039787559186,0.162397101163470,0.314626033850345,0.435682641667490,0.0828311524646456,0.175442057049183,0.0532737582744671,0.441698412757801,0.495044488334396,0.0436944546476733,0.175587114746424,0.101263513206633,0.636615702562385,0.153680439671818,0.0869200617881887,0.769644036841067,0.501492955517776,0.321206171998600,0.175559462654216,0.0846926862175211,0.0326982422713765;0.141825301220498,0.384223994165251,0.151191720184961,0.125461278338027,0.169093812293968,0.292778691189516,0.458065449088953,0.0816690148792721,0.216835258565392,0.0585896478376325,0.417290438650830,0.503298206463403,0.0432302578682026,0.160808821057271,0.137533974426406,0.631727596965299,0.190294104262140,0.0814766249475534,0.758706110064673,0.495102420250645,0.316931498040656,0.174714298908861,0.0846340555694953,0.0329770562878201;0.143134963298458,0.408253140375011,0.147622520179972,0.120138629043047,0.179387534300675,0.271215579929846,0.479514450419672,0.0810071286530130,0.265568891749873,0.0652227733457373,0.391406381091711,0.511009402331775,0.0429321979578585,0.146652133064823,0.180607384920548,0.625630627652914,0.233613071247030,0.0779701685702910,0.746937205366006,0.488858030156782,0.312438374363993,0.174046780253562,0.0848420817701436,0.0334337011018094;0.144043640531426,0.433693334444420,0.144598453095375,0.115148456406503,0.192152389974151,0.250398645160527,0.499364668363709,0.0807620648519017,0.317761150221206,0.0728683418440122,0.365201786471210,0.517898726511380,0.0427937728240317,0.133350267684563,0.227313175976813,0.618658220875498,0.280526483789858,0.0759182913525838,0.734713824858664,0.482670012696792,0.307754697795438,0.173390452552055,0.0851628137017719,0.0340078127037539;0.144632682051461,0.458792803610509,0.142078234577973,0.110567377160656,0.206262502104950,0.230789831970749,0.516951125625129,0.0808503945419716,0.369530227597971,0.0812215603776879,0.339832201180092,0.523686829574083,0.0428084803741127,0.121136441831972,0.274480778882952,0.611143802883320,0.327923485053995,0.0748385919906136,0.722412470656249,0.476448595331285,0.302908365161815,0.172578861668074,0.0854423002466860,0.0346390270840628;0.144983436990621,0.481799775110311,0.140020580274570,0.106472008037766,0.220591993483630,0.212851085449702,0.531608844907996,0.0811886887892559,0.416994317498748,0.0899776359919950,0.316453171609123,0.528094362091751,0.0429698185154922,0.110243872422535,0.318939624926720,0.603420799926647,0.372693218202812,0.0742486691805625,0.710409644872358,0.470104005520868,0.297927273289952,0.171445553465354,0.0855265902871916,0.0352669802331456;0.145177254480967,0.500962476180857,0.138384205831970,0.102938965770093,0.234014986900747,0.197044350686580,0.542672848916375,0.0816935186597881,0.456271613542117,0.0988317757321645,0.296220244149069,0.530841974636250,0.0432712851555609,0.100905776371732,0.357519145395868,0.595822638255749,0.411724826399681,0.0736661216186124,0.699081849620592,0.463546470726149,0.292839319006674,0.169824073807632,0.0852617327055947,0.0358313081414116;0.145295483654559,0.514529134059180,0.137127826896977,0.100044867089896,0.245405605146859,0.183831572770571,0.549478160354329,0.0822814552196015,0.483480309346657,0.107479186643427,0.280288965190695,0.531650317779445,0.0437063782017092,0.0933553705950463,0.387048771578150,0.588682744120895,0.441907452807972,0.0726085480009454,0.688805587014550,0.456686218407735,0.287672399138808,0.167547968558641,0.0844937763842011,0.0362716467992701;0.145297449945365,0.523375635126763,0.136272085646187,0.0977514036310448,0.255326786826687,0.172981779157081,0.552357267869825,0.0829942129356793,0.500561308103079,0.116072265203167,0.268081561538620,0.530659066235405,0.0442783487002420,0.0874760466347371,0.409113787829688,0.581834404396949,0.464796525845999,0.0713171489794705,0.679392605997432,0.449568134835324,0.282412565272939,0.164700464786515,0.0832996968818578,0.0366181782115166;0.145088246032651,0.529545714273736,0.135865147158332,0.0959691892059040,0.265092055351248,0.163956033908720,0.552085978308124,0.0839291255643161,0.512043383923039,0.124966603191948,0.258249895736949,0.528194127670285,0.0449947824258701,0.0829957180894080,0.427413190981438,0.574888621791932,0.484021378489830,0.0703547260753086,0.670403654103372,0.442296954638205,0.277027271111106,0.161475758983563,0.0818591038358747,0.0369413270560066;0.144667871916417,0.533039371500099,0.135907011433410,0.0946982238144732,0.274701410720543,0.156754337025489,0.548664291669224,0.0850861931055118,0.517926536806538,0.134162200609772,0.250793967785682,0.524255502084084,0.0458556793785936,0.0799143849590588,0.441946981033401,0.567845396305843,0.499582010739466,0.0697212792884598,0.661838731332371,0.434872677816379,0.271516516653306,0.157873851149784,0.0801719972462519,0.0372410933327403;0.144036327596662,0.533856606805853,0.136397678471422,0.0939385074567524,0.284154852934570,0.151376688507387,0.542092207953126,0.0864654155592664,0.518210766753576,0.143659057456637,0.245713777684819,0.518843189476804,0.0468610395584125,0.0782320472436896,0.452715157985575,0.560704727938684,0.511478422594905,0.0694168086189241,0.653697837684427,0.427295304369846,0.265880301899542,0.153894741285178,0.0782383771129893,0.0375174770417176;0.143193613073386,0.531997420190996,0.137337148272367,0.0936900401327416,0.293452381993330,0.147823088354414,0.532369727159830,0.0880667929255800,0.512896073764152,0.153457173732544,0.243009325434361,0.511957189848444,0.0480108629653267,0.0779487049433004,0.459717721837961,0.553466616690454,0.519710614056148,0.0694413140667014,0.645980973159542,0.419564834298605,0.260118626849811,0.149538429389746,0.0760582434360869,0.0377704781829385;0.142139728346589,0.527461811655528,0.138725420836246,0.0939528218424408,0.302593997896824,0.146093536566570,0.519496849289335,0.0898903252044526,0.501982457838266,0.163556549437492,0.242680611034308,0.503597503199004,0.0493051495993363,0.0790643580578912,0.462954672590560,0.546131062561152,0.524278585123195,0.0697947956317918,0.638688137757715,0.411681267602657,0.254231491504116,0.144804915463487,0.0736315962155447,0.0380000967564030;0.140874673416271,0.520249781199451,0.140562496163058,0.0947268525858499,0.311579700645050,0.146188033143855,0.503473574341643,0.0919360123958840,0.485469918975919,0.173957184571483,0.244727634484659,0.493764129528484,0.0507438994604412,0.0815790065874620,0.462426010243371,0.538698065550779,0.525182335796045,0.0704772533141953,0.631819331478946,0.403644604282002,0.248218895862455,0.139694199506402,0.0709584354513627,0.0382063327621112;0.139398448282433,0.510361328822764,0.142848374252804,0.0960121323629690,0.320409490238010,0.148106578086270,0.484299902316752,0.0942038544998743,0.463358457177110,0.184659079134515,0.249150395785414,0.482457068836883,0.0523271125486415,0.0854926505320127,0.458131734796393,0.531167625659335,0.522421866074700,0.0714886871139118,0.625374554323235,0.395454844336639,0.242080839924828,0.134206281518490,0.0680387611435410,0.0383891862000630];
    
    %% Basic inputs
    
    Observer.path = 'C:\Users\Admin\Desktop\PAINTERS_COPILOT';
    Observer.filename = 'ciexyz31.csv';
    Observer.source = 'http://cvrl.ioo.ucl.ac.uk/index.htm';
    Observer.description = 'Observer color matching functions: CIE 1931 2-deg';

    Illuminant.path = 'C:\Users\Admin\Desktop\PAINTERS_COPILOT';
    Illuminant.filename = 'illuminantd65.csv';
    Illuminant.source = 'http://cvrl.ioo.ucl.ac.uk/index.htm';
    Illuminant.description = 'Illuminant D65: average midday light in Western/Northern Europe';
    
    % Observer
    O = csvread([Observer.path '\' Observer.filename]);
    Observer.lambda = O(:,1);
    Observer.responses = O(:,2:end);
    Observer.Lab_JND = 2.3; % "just noticeable difference" in CIE76 color difference; source: https://en.wikipedia.org/wiki/Color_difference
    Observer.grayscale_weights = [0.21 0.72 0.07]; % RGB luminosity weighting
    
    % Illuminant
    I = csvread([Illuminant.path '\' Illuminant.filename]);
    Illuminant.lambda = I(:,1);
    Illuminant.power  = I(:,2);
    Illuminant.power = interp1(Illuminant.lambda,Illuminant.power,Observer.lambda); % Re-sample to match Observer
    Illuminant.power = Illuminant.power ./ max(Illuminant.power); % normalize 0-1
    Illuminant.lambda = Observer.lambda;
    
    %% Align curves with scalar gain using bisection method
    
    I_gain = interp1(Illuminant.lambda, Illuminant.power, lambda_act)';
    qty = size(R_act,2);
        
    ERR = [];
    Y_ACT = [];
    Y_EST = [];
   
    Gain_Lims = [0.1 10];
    Gain_Lims_prev = Gain_Lims;
    
    delta = Inf;
    
    % Resample measurements to match estimation domain
    for s = 1 : qty
        SPD_act(:,s) = interp1(lambda_act, R_act(:,s).*I_gain, lambda_est)';
    end
    
    while delta > 0.0001
        
        Act = SPD_act;
        Est = SPD_est .* mean(Gain_Lims);
        
        Err = Est - Act;
        
        [undershoot, ~] = min(Err(:));
        [overshoot,  ~] = max(Err(:));
        
        if sum(Err(:)) < 0 % sum(Err(:)) = 0
%         if abs(undershoot) > abs(overshoot) % overshoot = undershoot
            Gain_Lims(1) = mean(Gain_Lims);
        else
            Gain_Lims(2) = mean(Gain_Lims);
        end
        
        delta = abs(mean(Gain_Lims_prev) - mean(Gain_Lims));
        Gain_Lims_prev = Gain_Lims;
        
    end
    
    GAIN = mean(Gain_Lims);
    SPD_est = SPD_est .* GAIN;
    disp(['Applied gain of ' num2str(GAIN) ' to SPD_est for curve alignment'])
    
    %% Calculate curve error
    
    RSS = zeros(qty,1);
    RS  = zeros(qty,1);
    for s = 1 : qty
        RSS(s) = sum((SPD_est(:,s) - SPD_act(:,s)).^2);
        RS(s)  = sum(SPD_est(:,s) - SPD_act(:,s));
    end
    
    %% Evaulate actual vs. estimated colors
    
    % Initialize color matrices
    XYZ_act = zeros(qty,3);
    XYZ_est = zeros(qty,3);
    RGB_act = zeros(qty,3);
    RGB_est = zeros(qty,3);
    Lab_act = zeros(qty,3);
    Lab_est = zeros(qty,3);
    
    dE = zeros(qty,1); % color difference
    
    % Generate tristimulus values
    % Per http://www.brucelindbloom.com/index.html?Eqn_Spect_to_XYZ.html
    
    for s = 1 : qty
        
        for cc = 1 : 3
            
            % Actual measured color
            d_lambda = abs(mean(diff(lambda_act)));
            O = interp1(Observer.lambda, Observer.responses(:,cc), lambda_act);
            I = interp1(Illuminant.lambda, Illuminant.power, lambda_act);
            R = R_act(:,s)';
            XYZ_act(s,cc) = sum(O.*R.*I) * d_lambda;
            
            % Estimated color
            d_lambda = abs(mean(diff(lambda_est)));
            O = interp1(Observer.lambda, Observer.responses(:,cc), lambda_est);
            P = SPD_est(:,s)';
            XYZ_est(s,cc) = sum(O.*P) * d_lambda;
            
        end
        
    end
    
    disp([ 'mean(XYZ_est(:)) = ' num2str(mean(XYZ_est(:))) ])
    disp([ 'mean(XYZ_act(:)) = ' num2str(mean(XYZ_act(:))) ])
    
    % Normalize values
    O = interp1(Observer.lambda, Observer.responses(:,2), lambda_act);
    I = interp1(Illuminant.lambda, Illuminant.power, lambda_act);
    d_lambda = abs(mean(diff(lambda_act)));
    N = sum(O.*I) * d_lambda;
    
    XYZ_est = XYZ_est ./ N;
    XYZ_act = XYZ_act ./ N;
    
    for s = 1 : qty
        
        RGB_act(s,:) = xyz2rgb(XYZ_act(s,:), 'ColorSpace', 'srgb', 'WhitePoint', 'D65', 'OutputType', 'double');
        RGB_est(s,:) = xyz2rgb(XYZ_est(s,:), 'ColorSpace', 'srgb', 'WhitePoint', 'D65', 'OutputType', 'double');
        
        if ~isempty(find(RGB_act(s,:)>1)) || ~isempty(find(RGB_act(s,:)<0))
            warning(['RGB_act(' num2str(s) ',:) = ' num2str(RGB_act(s,:))])
        end
        if ~isempty(find(RGB_est(s,:)>1)) || ~isempty(find(RGB_est(s,:)<0))
            warning(['RGB_est(' num2str(s) ',:) = ' num2str(RGB_est(s,:))])
        end
        
        Lab_act(s,:) = xyz2lab(XYZ_act(s,:), 'WhitePoint', 'D65');
        Lab_est(s,:) = xyz2lab(XYZ_est(s,:), 'WhitePoint', 'D65');
        
        dE(s) = color_difference(Lab_act(s,:), Lab_est(s,:), 'CIEDE2000');
        
    end
    
    RGB_act(RGB_act<0) = 0;
    RGB_est(RGB_est<0) = 0;
    RGB_act(RGB_act>1) = 1;
    RGB_est(RGB_est>1) = 1;
    
    JND = dE ./ Observer.Lab_JND;
    
    %%
    
    figure(105)
        clf
        set(gcf,'color','white')
        pos = get(gcf,'position');
        set(gcf,'position',[pos(1) 200 1000 600])
        set(gcf, 'Renderer', 'opengl')
        
        for s = 1 : qty
            subplot(4,6,s)
            hold on
            
            xlim([400 700])
            ylim([0 1])
            
            fill([550 550 400 400], [1 0 0 1], RGB_act(s,:),'EdgeColor','none')
            fill([700 700 550 550], [1 0 0 1], RGB_est(s,:),'EdgeColor','none')
            
            grayscale = dot(Observer.grayscale_weights, RGB_act(s,:));
            if grayscale < 0.5
                col = [1 1 1];
            else
                col = [0 0 0];
            end
            
            y_act = R_act(:,s) .* I_gain;
            y_est = SPD_est(:,s);
            
            plot(lambda_act, y_act, '-', 'Color', col, 'LineWidth', 1)
            plot(lambda_est, y_est, ':', 'Color', col, 'LineWidth', 2)
            
            y_resample = interp1(lambda_act, y_act, lambda_est)';
            
% %             Show stations
%             for c = 1 : length(stations)
%                 plot([0 0]+stations(c), ylim, '-',  'Color', zeros(1,3)+0.5)
%                 plot([0 0]+stations(c), ylim, ':', 'Color', zeros(1,3)+1)
%             end
            
            grid on
            set(gca,'XTick', stations)
            set(gca,'XTickLabel',{})
            set(gca,'YTick', [])
            
            text(min(xlim), max(ylim), ['\bf' num2str(s) ': \rm' num2str(round(dE(s)*100)/100) ' \DeltaE'],'HorizontalAlignment','left','VerticalAlignment','bottom','FontSize',12)
            
        end
        
        mid = mean([min(dE),max(dE)]);
        disp(['dE: ' num2str(mid) ' ± ' num2str(mid-min(dE))])
        disp(['dE_max: ' num2str(max(dE(:))) ])
        
    %%
    
    Luminance = zeros(qty,1);
    y_bar = interp1(Observer.lambda, Observer.responses(:,2), lambda_est)';
    
    for s = 1 : qty
        Luminance(s) = dot(y_bar, SPD_act(:,s));
    end
    
    figure(223)
    clf
    set(gcf,'color','white')
    scatter(Luminance, RSS, 'k.')
    grid on
    grid minor
    xlabel('Luminance, ~')
    ylabel('Residual sum of squares, ~')
    
    figure(224)
    clf
    set(gcf,'color','white')
    scatter(Luminance, RS, 'k.')
    grid on
    grid minor
    xlabel('Luminance, ~')
    ylabel('Residual sum, ~')
    
end


















































